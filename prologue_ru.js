import { m } from "../macros.js";
import { state } from "../../core/state.js";

export const story = {
  // === ПРОЛОГ: ДОПРОС В ТЕМНОТЕ ===
  prologue_interrogation: {
    id: "prologue_interrogation",
    bg: "./bg/dream_man.png",
    ...m.bgm("tension", 0.3),
    action: () => m.fx({ darkness: 1, noise: 0.2, duration: 0 }),
    lines: [
      {
        speaker: "mystery",
        text: "Рен.",
      },
      {
        speaker: "mystery",
        text: "Ты меня слышишь?",
      },

      {
        speaker: "ren",
        text: "Да...",
        action: () => m.fx({ darkness: 0.9, noise: 0.2, duration: 500 }),
      },
      {
        speaker: "",
        text: "Силуэт в деловом костюме сидит напротив. Я чувствую запах дорогого табака и старой бумаги.", // Атмосфернее
        ...m.sfx("step_slow"),
      },
      {
        speaker: "",
        text: "Я попытался дернуться. Бесполезно. Руки привязаны к подлокотникам.",
        action: () => m.fx({ darkness: 1, noise: 0.2, duration: 500 }),
      },
      { speaker: "", text: "Я в ловушке.", ...m.sanity(-10) },
      {
        speaker: "mystery",
        text: "Ты понимаешь, почему ты здесь?",
        action: () => m.fx({ darkness: 0.5, noise: 0.2, duration: 500 }),
      },
    ],
    choices: [
      { text: "Смутно...", next: "prologue_contract" },
      { text: "...", next: "prologue_contract" },
    ],
  },

  prologue_contract: {
    id: "prologue_contract",
    bg: "./bg/dream_man.png",
    lines: [
      {
        speaker: "mystery",
        text: "Статья 134. Умышленное причинение тяжкого вреда здоровью. Плюс сопротивление при аресте.",
      },
      {
        speaker: "mystery",
        text: "В колонии общего режима тебя сломают за пару дней. Ты слишком... смазливый для местного контингента.",
      },
      { speaker: "ren", text: "..." },
      { speaker: "mystery", text: "Но у меня есть альтернатива." },
      {
        speaker: "mystery",
        text: "Частная школа 'Синсю'. Закрытое учреждение для... коррекции поведения.",
      },
      { speaker: "mystery", text: "Или тюрьма. Выбор за тобой." },
      {
        speaker: "",
        text: "Человек положил на стол документ и тонкую иглу.",
        ...m.sfx("metal_clink"),
        bg: "./bg/dream_table.png",
      },
      { speaker: "mystery", text: "Заявление о добровольном переводе." },
      { speaker: "mystery", text: "Решай." },
    ],
    choices: [
      { text: "Хорошо...", next: "prologue_sign" },
      {
        text: "Даже не подумаю.",
        next: "bad_end",
        req: { stat: "dominance", value: 80 },
      },
    ],
  },

  prologue_sign: {
    id: "prologue_sign",
    bg: "./bg/dream_table.png",
    lines: [
      {
        speaker: "",
        text: "Он освободил мою правую руку. Я потянулся к ручке, но он перехватил моё запястье.",
      },
      { speaker: "mystery", text: "Не ручкой, Рен." },
      {
        speaker: "",
        text: "Резкий укол в подушечку пальца. Я даже не успел дернуться.",
        ...m.sfx("stab_sound"),
        ...m.sanity(-30),
      },
      { speaker: "ren", text: "Мх.." },
      {
        speaker: "mystery",
        text: "Твоё согласие должно быть абсолютным. Биологическим.",
      },
      {
        speaker: "",
        text: "Алая капля упала на бумагу. Моя кровь впиталась.",
        ...m.sanity(-40),
      },
      { speaker: "mystery", text: "Вот так. Теперь всё будет по-другому." },
      {
        speaker: "mystery",
        text: "Тебе там понравится, Рен.",
      },
      {
        speaker: "mystery",
        text: "Ты ведь любишь, когда тебя ломают?",
      },
      {
        speaker: "mystery",
        text: "ИЛИ ХОЧ$ШЬ Л@МАТЬ ИХ САМ?!", // Глитч-голос демона
        ...m.sanity(-80),
        ...m.sfx("glitch_start"),
        anim: "psychoShake",
      },
      {
        speaker: "mystery",
        text: "КРОВЬ! ЕЩЁ БОЛ#Ш% К!О&И! %$#@!",
        ...m.sanity(-100),
        ...m.sfx("scream_glitch"),
      },
    ],
    next: "bus_wakeup",
  },

  bus_wakeup: {
    id: "bus_wakeup",
    bg: "assets/bg/bus_rain.webp",
    ...m.bgm("rain_loop", 0.6),
    anim: "fadeIn",
    lines: [
      {
        action: () => m.fx({ darkness: 0, noise: 0, duration: 100 }),
        speaker: "",
        text: "...",
        ...m.sanity(100),
      },
      { speaker: "", text: "тяжёлое дыхание..." },
      {
        speaker: "",
        text: "Сердце колотится так, будто хочет проломить ребра.",
        ...m.sfx("heartbeat_slow"),
      },
    ],
    next: "bus_arrival",
  },

  bus_arrival: {
    id: "bus_arrival",
    bg: "assets/bg/bus_rain.webp",
    lines: [
      {
        speaker: "",
        text: "Автобус дернулся и заглох. Шум двигателя сменился монотонным стуком дождя по крыше.",
      },
      { speaker: "driver", text: "Конечная. Дальше не еду." },
      {
        speaker: "",
        text: "Я выглянул в окно. Сквозь мутное стекло проступали очертания массивных бетонных стен.",
      },
      {
        speaker: "ren",
        text: "Это... школа? Больше похоже на тюрьму строгого режима.",
      },
      {
        speaker: "driver",
        text: "Нулевой сектор. Академия для «особо одаренных».",
      },
      {
        speaker: "",
        text: "Двери автобуса с шипением открылись, впуская в салон запах мокрого асфальта и озона.",
      },
      {
        speaker: "driver",
        text: "Эй, парень. Съеби уже. Я тебя и так 2 часа вёз.",
      },
      {
        speaker: "",
        text: "Он посмотрел на меня через зеркало заднего вида. Глаз не было видно за тенью козырька, только кривую ухмылку.",
      },
      { speaker: "ren", text: "Да иду я..." },
    ],
    interactables: [
      {
        type: "exit",
        label: "Выйти под дождь",
        pos: { x: 85, y: 65 },
        next: "meet_kagami",
      },
    ],
  },

  meet_kagami: {
    id: "meet_kagami",
    ...m.show("kagami", "neutral", "center", "fadeIn"),
    lines: [
      {
        speaker: "",
        text: "Стоило мне выйти из автобуса, как меня встретила она...",
      },
      {
        speaker: "", // ОПИСАНИЕ
        text: "Пышногрудая красавица лет тридцати с уставшим взглядом и тугим хвостом темных волос. От неё пахнет дешевым вином.",
      },
      { speaker: "ren", text: "Здравствуйте, я..." },
      {
        speaker: "kagami",
        text: "Знаю. Амано Рен. Личное дело уже прочитано и сожжено.",
      },
      { speaker: "ren", text: "...Ладно..." },
      {
        speaker: "",
        text: "Лил дождь. Она подошла ко мне — близко, но не интимно — и протянула отдельный зонтик.",
        ...m.sfx("umbrella_open"),
      },
      {
        speaker: "kagami",
        text: "Меня зовут Кагами Саэ. Я занимаюсь распределением учеников по кварталам.",
      },
      {
        speaker: "kagami",
        text: "Позади меня — академия Синсю. Поздравляю с приездом, Амано.",
      },
      { speaker: "ren", text: "Да, спасибо. Зовите меня просто Рен." },
      {
        speaker: "kagami",
        text: "Хорошо, далее тебя ждет тест на способности. Прошу за мной.",
      },
      {
        speaker: "",
        text: "Мы двинулись. Я шёл чуть позади, и мой взгляд то и дело падал на её бедра, обтянутые юбкой.",
        ...m.sfx("step_puddle"),
      },
      {
        speaker: "ren",
        text: "Кагами-сенсей, расскажите про эту школу. Меня перевели из маленького городка...",
      },
      {
        speaker: "ren",
        text: "Я даже не знаю, за какие заслуги мне дали такую возможность.",
      },
      { speaker: "kagami", text: "Заслуги? Здесь нет заслуг прошлого." },
      {
        speaker: "kagami",
        text: "Есть только потенциал, который ты либо реализуешь, либо...",
      },
      { speaker: "kagami", text: "Либо нет." },
      {
        speaker: "kagami",
        text: "Ты первый, кто вторгся в середине семестра. Обычно здесь учатся с самого начала.",
      },
      { speaker: "ren", text: "Вот оно как..." },
      {
        speaker: "",
        text: "Пока мы шли, боковым зрением я заметил нечто... неправильное. Силуэт в тени бетона.",
        ...m.sfx("step_puddle"),
      },
      { speaker: "ren", text: "Чё за...", ...m.sanity(-5) },
      {
        speaker: "",
        text: "Я остановился. Дождь барабанил по металлическому навесу, под которым сидела она.",
      },
      {
        speaker: "",
        text: "Ученица. Полностью обнаженная. Её кожа была бледной.",
      },
      {
        speaker: "",
        text: "От массивного столба тянулась ржавая цепь. Она уходила прямо к кожаному ошейнику на её тонкой шее.",
        ...m.sfx("chain_rattle_faint"),
      },
      {
        speaker: "",
        text: "Она сидела неподвижно, обняв колени. Вода стекала по её спутанным волосам, капая на грязный бетон.",
      },
      {
        speaker: "",
        text: "Это выглядело как арт-инсталляция больного человека. Или как казнь.",
        ...m.sanity(-5),
      },
      { speaker: "kagami", text: "Рен, ты чего застыл?" },
      {
        speaker: "",
        text: "Голос Кагами звучал буднично, совершенно спокойно.",
      },
      { speaker: "ren", text: "Я..." },
    ],
    interactables: [
      {
        type: "look",
        label: "Подойти ближе к ученице",
        pos: { x: 45, y: 60 },
        effects: { rank: -5, dominance: 1 },
        next: "approach_girl",
      },
      {
        type: "exit",
        label: "Идти дальше",
        pos: { x: 90, y: 50 },
        effects: { rank: -5, dominance: -2 },
        next: "ignore_girl",
      },
    ],
  },

  approach_girl: {
    id: "approach_girl",
    lines: [
      { speaker: "ren", text: "Эмм, я сейчас..." },
      {
        speaker: "",
        text: "Я сделал шаг с дорожки. Грязь чавкнула под ботинками. Кагами тяжело вздохнула позади, но не остановила меня.",
        ...m.sfx("step_slow"),
      },
      {
        speaker: "",
        text: "С каждым шагом детали становились четче. Ссадины на плечах. Странная белая жидксоть на ступнях.",
      },
      {
        speaker: "",
        text: "Она услышала меня. Медленно, дергано подняла голову.",
      },
      {
        speaker: "",
        text: "Она смотрит на меня. Её глаза выражали совершенно не понятную мне эмоцию.",
      },
      {
        speaker: "",
        text: "Она облизнула пересохшие губы и улыбнулась. Жутко. Призывно.",
        ...m.sanity(-5),
      },
      { speaker: "ren", text: "Что мне сделать...?" },
    ],
    choices: [
      {
        text: "Поговорить",
        next: "talk_to_girl",
      },
      {
        text: "Попытаться помочь",
        effects: { rank: -5, dominance: 1 },
        next: "help_girl",
      },
      {
        text: "Рассмеяться ей в лицо",
        req: { stat: "dominance", value: 15 },
        next: "laugh_at_girl",
      },
      {
        text: "Сексуальное действие",
        req: { stat: "dominance", value: 30 },
        next: "inspect_girl",
      },
    ],
  },

  ignore_girl: {
    id: "ignore_girl",
    lines: [
      { speaker: "", text: "Я отвернулся." },
      { speaker: "ren", text: "Эмм, ничего. Идемте." },
      {
        speaker: "",
        text: "Что это было? Часть теста? Психологическая проверка? Если я отреагирую — я провалюсь?",
        ...m.sanity(-5),
      },
      {
        speaker: "",
        text: "Мы шли еще минуту, пока не дошли до маленькой пристройки.",
      },
    ],
    next: "quiz_intro",
  },

  talk_to_girl: {
    id: "talk_to_girl",
    lines: [
      { speaker: "ren", text: "Эй, что с тобой? Почему ты голая?" },
      { speaker: "mystery", text: "А почему ты одетый?" },
      { speaker: "ren", text: "?" },
      {
        speaker: "mystery",
        text: "Я вот нарушила правила.",
      },
      {
        speaker: "mystery",
        text: "Но я хотела просто обнять...",
      },
      {
        speaker: "mystery",
        text: "А меня повязали и прицепили сюда.",
      },
      {
        speaker: "mystery",
        text: "Теперь я обнимаюсь с кем скажут.",
      },
      {
        speaker: "mystery",
        text: "Хахаха..",
      },
      {
        speaker: "",
        text: "Она тихо посмеялась.. Или заплакала?",
      },
      {
        speaker: "mystery",
        text: "И тут же начала тянуться рукой ко мне",
      },
      { speaker: "mystery", text: "Ну а ты? Тоже за мной, да?!" },
      {
        speaker: "mystery",
        text: "Тоже хочешь меня схватить ?!",
      },
      {
        speaker: "",
        text: "Я начал пятиться назад, но она уже зацепилась за мой ремень",
      },
      {
        speaker: "ren",
        text: "Вот блядь, отпусти!",
      },
      {
        speaker: "",
        text: "БАМ! Мне прилетел удар зонтом по затылку. Не сильный, но отрезвляющий.",
        ...m.sfx("hit_umbrella"),
        anim: "psychoShake", // Легкая встряска экрана
      },
      {
        speaker: "",
        text: "Девчонка отпустила меня и вернулась на место.",
      },
      { speaker: "kagami", text: "Рен, отойди от брака." },
      { speaker: "ren", text: "Ай-яй..." },
      { speaker: "", text: "Это..." },
      { speaker: "ren", text: "Это пиздец..." },
      {
        speaker: "",
        text: "Кагами схватила меня за руку и потащила прочь.",
      },
      {
        speaker: "kagami",
        text: "Кто тебе разрешал бродить где попало? Мы идем на тестирование.",
      },
      {
        speaker: "",
        text: "Она предлагает мне просто забыть об этом? Пока мы шли, я пытался остудить голову.",
      },
    ],
    next: "quiz_intro",
  },

  help_girl: {
    id: "help_girl",
    lines: [
      { speaker: "", text: "Это... кошмар. Я осматриваю цепь." },
      { speaker: "ren", text: "Эй, кто сделал это с тобой? Где ключ?" },
      {
        speaker: "mystery",
        text: "Ключ? Ммм... Никто не знает, где ключи. Иначе мои подруги...",
      },
      { speaker: "mystery", text: "Освободили бы меня! Ахахах!" },
      { speaker: "", text: "Я опешил от её смеха." },
      { speaker: "ren", text: "Как мне помочь тебе?" },
      { speaker: "", text: "Она медленно раздвинула ноги." },
      { speaker: "mystery", text: "Лижи." },
      { speaker: "ren", text: "...Что?" },
    ],
    choices: [
      {
        text: "Облизнуться",
        effects: { dominance: 2, sanity: -5 },
        next: "lick_reaction",
      },
      {
        text: "Отшатнуться",
        next: "recoil_reaction",
      },
    ],
  },

  lick_reaction: {
    id: "lick_reaction",
    lines: [
      {
        speaker: "",
        text: "Я попытался отвернуться, но не смог. Взгляд упал на её мокрую промежность.",
      },
      { speaker: "", text: "Она возбуждена... И её щёлка явно потрёпана." },
      { speaker: "", text: "Девчонка улыбается, глядя мне прямо в душу." },
      {
        speaker: "",
        text: "Ох, черт... Мой член... Он реагирует.",
        ...m.sanity(-10),
        ...m.sfx("heartbeat_fast"),
      },
      { speaker: "kagami", text: "РЕН!" }, // Крик повышает напряжение
      { speaker: "", text: "Резкий рывок за руку вернул меня в реальность." },
    ],
    next: "dragged_away",
  },

  recoil_reaction: {
    id: "recoil_reaction",
    lines: [
      { speaker: "", text: "Боже правый, что с ней не так?!" },
      { speaker: "ren", text: "Да ни за что! Какого хера ты вообще..." },
      { speaker: "kagami", text: "РЕН!" },
      { speaker: "", text: "Резкий рывок за руку прервал меня." },
    ],
    next: "dragged_away",
  },

  dragged_away: {
    id: "dragged_away",
    lines: [
      { speaker: "kagami", text: "Кто тебе разрешал отходить? Мы опаздываем." },
      {
        speaker: "",
        text: "Она тащила меня прочь, словно нашкодившего щенка.",
      },
      {
        speaker: "",
        text: "Она хочет, чтобы я забыл увиденное? Да это же безумие...",
      },
      {
        speaker: "",
        text: "Мы шли еще минуту, пока не добрались до маленькой пристройки.",
      },
    ],
    next: "quiz_intro",
  },

  // ============================================
  // === QUIZ: INTRO (НЕ ПЕРЕИМЕНОВЫВАТЬ) ===
  // ============================================

  // ============================================
  // === QUIZ: INTRO (НЕ ПЕРЕИМЕНОВЫВАТЬ) ===
  // ============================================
  quiz_intro: {
    id: "quiz_intro",
    bg: "./bg/quiz_room.png",
    ...m.bgm("tension_low", 0.2),
    lines: [
      {
        speaker: "",
        text: "Мы вошли внутрь... Стерильное место, полностью белое.",
      },
      { speaker: "", text: "Стены, пол, потолок..." },
      {
        speaker: "",
        text: "Два стола стоят напротив друг друга и одна доска.",
      },
      { speaker: "kagami", text: "Присаживайся." },
      { speaker: "", text: "На парте уже лежит бумага с тестом и ручка." },
      { speaker: "kagami", text: "Пока что не переворачивай листок." },
      { speaker: "", text: "Я сел за парту." },
      {
        speaker: "",
        text: "Кагами сложила наши зонты в корзину и села напротив меня.",
      },
      {
        speaker: "kagami",
        text: "Правила простые, у тебя 20 минут, чтобы ответить на 8 вопросов.",
      },
      {
        speaker: "kagami",
        text: "Чтобы пройти тест, хотя бы 4 должны быть правильными.",
      },
      {
        speaker: "kagami",
        text: "Как только закончишь — положи ручку на парту и подними руку.",
      },
      {
        speaker: "kagami",
        text: "Других учеников хоть и нет, но золотое правило каждого теста или экзамена — молчание.",
      },
      {
        speaker: "kagami",
        text: "Как только перевернёшь листок — таймер пойдёт.",
      },
      { speaker: "kagami", text: "Вопросы?" },
      { speaker: "", text: "Думаю лишь один, самый логичный." },
      { speaker: "ren", text: "А если не отвечу?" },
      { speaker: "kagami", text: "Провалишь тест и вернёшься откуда пришёл." },
      { speaker: "", text: "Честно и чётко. Ладно, посмотрим, что за тест." },
    ],
    interactables: [
      {
        type: "look",
        label: "Листок",
        pos: { x: 62, y: 72 },
        action: () => {
          // --- ИНИЦИАЛИЗАЦИЯ ТЕСТА ---
          if (!state.temp) state.temp = {};
          state.temp.quizScore = 0;
          state.temp.kagamiStare = false;

          // --- ТАЙМЕР НА 20 МИНУТ (1 200 000 мс) ---
          window.quizTimer = setTimeout(() => {
            window.dispatchEvent(
              new CustomEvent("loadScene", { detail: "quiz_afk_fail" }),
            );
            // БОЛЬШЕ НЕ ПРЯЧЕМ dialog-wrapper, сцена сама всё покажет
          }, 1200000);
        },
        next: "quiz_q1",
      },
    ],
  },

  // ============================================
  // === ВОПРОС 1 ===
  // ============================================
  quiz_q1: {
    id: "quiz_q1",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "",
        text: "Вопрос 1: Какой гормон отвечает за формирование поведения подчинения при длительном социальном давлении?",
      },
      { speaker: "", text: "А. Кортизол" },
      { speaker: "", text: "Б. Окситоцин" },
      { speaker: "", text: "В. Тестостерон" },
      { speaker: "", text: "Г. Серотонин" },
      { speaker: "", text: "....." },
      { speaker: "", text: "Чего нах..?" },
    ],
    choices: [
      { text: "Вписать ответ", next: "quiz_q1_pick" },
      {
        text: "Задать вопрос Кагами (+1 дом)",
        effects: { dominance: 1 },
        next: "quiz_q1_warn",
      },
    ],
  },

  quiz_q1_warn: {
    id: "quiz_q1_warn",
    bg: "./bg/quiz_room.png",
    lines: [
      { speaker: "ren", text: "Кагами-сен..." },
      {
        speaker: "",
        text: "Кагами стукнула по столу. Не сильно, не от злости, а просто, чтобы заткнуть меня.",
      },
      { speaker: "kagami", text: "Ещё раз нарушишь правило и провалишь." },
      {
        speaker: "",
        text: "Да вы вопросы эти читали? Может это подстава? Она перепутала бумаги?",
      },
      { speaker: "", text: "… Ладно, ничего сейчас не остаётся." },
    ],
    next: "quiz_q1_pick",
  },

  quiz_q1_pick: {
    id: "quiz_q1_pick",
    bg: "./bg/quiz_room.png",
    lines: [{ speaker: "", text: "Выбираю наугад." }],
    choices: [
      { text: "А. Кортизол", next: "quiz_q2" },
      {
        text: "Б. Окситоцин",
        action: () => {
          state.temp.quizScore++;
        },
        next: "quiz_q2",
      }, // ✅
      { text: "В. Тестостерон", next: "quiz_q2" },
      { text: "Г. Серотонин", next: "quiz_q2" },
    ],
  },

  // ============================================
  // === ВОПРОС 2 ===
  // ============================================
  quiz_q2: {
    id: "quiz_q2",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "",
        text: "Вопрос 2: Какой показатель наименее надёжен для оценки искреннего согласия?",
      },
      { speaker: "", text: "A) Вербальное 'да'" },
      { speaker: "", text: "B) Поза тела" },
      { speaker: "", text: "C) Пульс/дыхание" },
      { speaker: "", text: "D) Последовательность действий после события" },
      {
        speaker: "",
        text: "… Значит это был не единственный такой вопрос? Я готов решить квадратное уравнение, но что это такое?!",
      },
      {
        speaker: "",
        text: "Я поднял глаза на Кагами. Она смотрит то в телефон, то на меня. Это игра глазами? Она знает, что здесь не академические вопросы?",
      },
      {
        speaker: "",
        text: "Никакой реакции с её стороны, она просто следит за порядком.",
      },
    ],
    choices: [
      {
        text: "Продолжить пялиться (+3 дом)",
        action: () => {
          state.temp.kagamiStare = true;
        },
        effects: { dominance: 3 },
        next: "quiz_q2_stare",
      },
      { text: "Перейти к ответу", next: "quiz_q2_pick" },
    ],
  },

  quiz_q2_stare: {
    id: "quiz_q2_stare",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "",
        text: "Хмф, ну раз вы молчите и даже не удосужились меня предупредить о таких вопросах, то думаю можно полюбоваться.",
      },
      {
        speaker: "",
        text: "Я смотрю на её грудь под красной блузкой. Она такая пышная, охренеть...",
      },
      { speaker: "", text: "Какой у неё вообще размер? Это не меньше 4." },
      { speaker: "", text: "Я бы её помацал." },
      { speaker: "", text: "Взгляд переходит вниз." },
      {
        speaker: "",
        text: "Эй, и ножки такие сексуальные... Чёрные носочки в туфлях, открытая щиколотка...",
      },
      { speaker: "", text: "Кагами, да вы меня соблазняете?" },
      {
        speaker: "",
        text: "Член твердеет, натягивая мои штаны, но под партой этого не видно.",
      },
      {
        speaker: "",
        text: "Я приулыбнулся, посмотрел ей в глаза. 0 эмоций, её не волнует, что ученик прям на тесте раздел её взглядом. Ни возбуждения, ни отвращения.",
      },
      { speaker: "", text: "Блять, время, точно!" },
    ],
    next: "quiz_q2_pick",
  },

  quiz_q2_pick: {
    id: "quiz_q2_pick",
    bg: "./bg/quiz_room.png",
    lines: [{ speaker: "", text: "Ладно. Отвечаем." }],
    choices: [
      {
        text: "A) Вербальное 'да'",
        action: () => {
          state.temp.quizScore++;
        },
        next: "quiz_q3",
      }, // ✅
      { text: "B) Поза тела", next: "quiz_q3" },
      { text: "C) Пульс/дыхание", next: "quiz_q3" },
      { text: "D) Последовательность действий после события", next: "quiz_q3" },
    ],
  },

  // ============================================
  // === ВОПРОС 3 ===
  // ============================================
  quiz_q3: {
    id: "quiz_q3",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "",
        text: "Вопрос 3: При одинаковых вводных, доля субъектов, которые меняют линию поведения после первого наказания (в пределах 72 часов), составляет:",
      },
      { speaker: "", text: "A) 18%" },
      { speaker: "", text: "B) 37%" },
      { speaker: "", text: "C) 61%" },
      { speaker: "", text: "D) 84%" },
      {
        speaker: "",
        text: "О чём вообще идёт речь? Я в это даже вдумываться не хочу.",
      },
    ],
    choices: [
      { text: "A) 18%", next: "quiz_q4" },
      { text: "B) 37%", next: "quiz_q4" },
      {
        text: "C) 61%",
        action: () => {
          state.temp.quizScore++;
        },
        next: "quiz_q4",
      }, // ✅
      { text: "D) 84%", next: "quiz_q4" },
    ],
  },

  // ============================================
  // === ВОПРОС 4 ===
  // ============================================
  quiz_q4: {
    id: "quiz_q4",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "",
        text: "Вопрос 4: Какое действие усиливает эффект принуждения сильнее всего при прочих равных?",
      },
      { speaker: "", text: "A) Объяснение причин" },
      { speaker: "", text: "B) Лишение выбора в мелочах" },
      { speaker: "", text: "C) Повышение голоса" },
      { speaker: "", text: "D) Присутствие свидетелей" },
      {
        speaker: "",
        text: "Каждый новый вопрос всё меньше поражает меня. Это то, что ученики здесь проходят?",
      },
    ],
    choices: [
      { text: "A) Объяснение причин", next: "quiz_q5" },
      {
        text: "B) Лишение выбора в мелочах",
        action: () => {
          state.temp.quizScore++;
        },
        next: "quiz_q5",
      }, // ✅
      { text: "C) Повышение голоса", next: "quiz_q5" },
      { text: "D) Присутствие свидетелей", next: "quiz_q5" },
    ],
  },

  // ============================================
  // === ВОПРОС 5 ===
  // ============================================
  quiz_q5: {
    id: "quiz_q5",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "",
        text: "Вопрос 5: Какое вещество используется в качестве базового агента при добровольной коррекции поведения:",
      },
      { speaker: "", text: "А. Мидазолам" },
      { speaker: "", text: "Б. Налтрексон" },
      { speaker: "", text: "В. Флуоксетин" },
      { speaker: "", text: "Г. Окситоцин синтетический" },
      {
        speaker: "",
        text: "А впрочем, что раньше я отвечал наугад, что сейчас. Ничего не изменилось.",
      },
    ],
    choices: [
      { text: "А. Мидазолам", next: "quiz_q6" },
      { text: "Б. Налтрексон", next: "quiz_q6" },
      { text: "В. Флуоксетин", next: "quiz_q6" },
      {
        text: "Г. Окситоцин синтетический",
        action: () => {
          state.temp.quizScore++;
        },
        next: "quiz_q6",
      }, // ✅
    ],
  },

  // ============================================
  // === ВОПРОС 6 ===
  // ============================================
  quiz_q6: {
    id: "quiz_q6",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "",
        text: "Вопрос 6: Какое из состояний наиболее продуктивно для обучаемого:",
      },
      { speaker: "", text: "А. Спокойствие и уверенность" },
      { speaker: "", text: "Б. Лёгкая тревога" },
      { speaker: "", text: "В. Острый страх" },
      { speaker: "", text: "Г. Полное безразличие" },
      { speaker: "", text: "Этот кажется лёгким и даже адекватным." },
    ],
    choices: [
      { text: "А. Спокойствие и уверенность", next: "quiz_q7" },
      { text: "Б. Лёгкая тревога", next: "quiz_q7" },
      {
        text: "В. Острый страх",
        action: () => {
          state.temp.quizScore++;
        },
        next: "quiz_q7",
      }, // ✅
      { text: "Г. Полное безразличие", next: "quiz_q7" },
    ],
  },

  // ============================================
  // === ВОПРОС 7 (ветка от доминации) ===
  // ============================================
  quiz_q7: {
    id: "quiz_q7",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "",
        text: "Вопрос 7: Минимальный порог болевого воздействия для коррекции поведенческой девиации составляет:",
      },
      { speaker: "", text: "А. 2–4 Н/см²" },
      { speaker: "", text: "Б. 8–12 Н/см²" },
      { speaker: "", text: "В. 15–20 Н/см²" },
      { speaker: "", text: "Г. Индивидуален, стандарт неприменим" },
      { speaker: "", text: "Это даже не смешно уже." },
    ],
    choices: [
      {
        text: "А. 2–4 Н/см²",
        next: "quiz_q8",
      },
      {
        text: "Б. 8–12 Н/см²",
        next: "quiz_q8",
      },
      {
        text: "В. 15–20 Н/см²",
        next: "quiz_q8",
      },
      {
        text: "Г. Индивидуален, стандарт неприменим",
        action: () => {
          state.temp.quizScore++;
        },
        next: "quiz_q8",
      },
    ],
  },

  // ============================================
  // === ВОПРОС 8 (ЧИТАЕМ ТЕКСТ) ===
  // ============================================
  quiz_q8: {
    id: "quiz_q8",
    bg: "./bg/quiz_room.png",
    lines: [
      { speaker: "", text: "Вопрос 8: Вы провалили тест. Ваши действия:" },
      { speaker: "", text: "A) Потребовать пересдачи" },
      {
        speaker: "",
        text: "B) Принять результат и следовать инструкциям куратора",
      },
      { speaker: "", text: "C) Покинуть учреждение" },
      { speaker: "", text: "D) Оспорить правомерность теста" },
    ],
    // Вот тут магия! Как только текст закончится, движок проверит стат:
    next: () =>
      state.hero.stats.dominance >= 5 ? "quiz_q8_auto" : "quiz_q8_manual",
  },

  // Ветка 1: Доминация ВЫСОКАЯ (ГГ отвечает сам)
  quiz_q8_auto: {
    id: "quiz_q8_auto",
    bg: "./bg/quiz_room.png",
    lines: [
      { speaker: "", text: "Оспорить блядскую правомерность. Я обвёл D." },
      {
        speaker: "",
        text: "Даже не думал. Терпеть это дерьмо я не собираюсь.",
      },
    ],
    // (D - неправильный ответ, поэтому score не прибавляем)
    next: "quiz_end_check",
  },

  // Ветка 2: Доминация НИЗКАЯ (Игрок выбирает сам)
  quiz_q8_manual: {
    id: "quiz_q8_manual",
    bg: "./bg/quiz_room.png",
    lines: [
      { speaker: "", text: "Последний вопрос... Нужно выбрать аккуратно." },
    ],
    choices: [
      { text: "A) Потребовать пересдачи", next: "quiz_end_check" },
      {
        text: "B) Принять результат и следовать инструкциям куратора",
        action: () => {
          state.temp.quizScore++;
        }, // ✅ Правильный
        next: "quiz_end_check",
      },
      { text: "C) Покинуть учреждение", next: "quiz_end_check" },
      { text: "D) Оспорить правомерность теста", next: "quiz_end_check" },
    ],
  },

  // ============================================
  // === ПРОВЕРКА РЕЗУЛЬТАТА И ОСТАНОВКА ТАЙМЕРА ===
  // ============================================
  quiz_end_check: {
    id: "quiz_end_check",
    bg: "./bg/quiz_room.png",
    // Action сцены срабатывает СРАЗУ при загрузке сцены.
    // Это идеальное место, чтобы прибить таймер.
    action: () => {
      if (window.quizTimer) {
        clearTimeout(window.quizTimer);
        window.quizTimer = null; // Зачищаем за собой
      }
    },
    lines: [
      {
        speaker: "",
        text: "Я положил ручку на стол и поднял руку.",
      },
      {
        speaker: "",
        text: "Кагами встала со своего места, подошла ко мне и забрала листок с парты.",
      },
      {
        speaker: "",
        text: "Она проверяет мои ответы, не отходя.",
      },
      {
        speaker: "",
        text: "Я просто замер, слушая её дыхание.",
        // Небольшая пауза для напряжения перед вердиктом
        fx: { duration: 1500 },
      },
    ],
    // Бесшовный переход к результату сразу после последней строчки текста!
    next: () => {
      // 1. Проверяем, набрал ли игрок 4 балла
      if ((state.temp.quizScore || 0) >= 4) {
        // 2. Если набрал — проверяем, пялился ли он на 2-м вопросе
        if (state.temp.kagamiStare === true) {
          return "quiz_pass_stared"; // Сдал, но будет наказан за взгляд
        } else {
          return "quiz_pass_clean"; // Сдал чисто
        }
      }
      // 3. Если меньше 4 баллов — жесткий провал и лизание каблука
      return "quiz_fail";
    },
  },

  // ============================================
  // КОНЦОВКА 1: ПРОШЕЛ ЧИСТО (>= 4 ответа, не пялился)
  // ============================================
  quiz_pass_clean: {
    id: "quiz_pass_clean",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "kagami",
        text: "Поздравляю, ты сдал..",
        showCharacter: { id: "kagami", emotion: "neutral", position: "center" },
      },
      { speaker: "", text: "Она это сказала с какой-то грустинкой в голосе." },
      { speaker: "", text: "Она не разочарована моим поступлением?" },
      {
        speaker: "",
        text: "Кагами открыла дверь из этой комнаты и выключила свет.",
        fx: { darkness: 0.8, duration: 1000 },
        audio: { type: "sfx", id: "door_open" }, // Замени на свой ID звука, если есть
      },
      {
        speaker: "kagami",
        text: "Пойдём, Рен. Теперь пройдёмся по правилам.",
        hideCharacter: "kagami",
      },
    ],
    // Тут переход на следующую глобальную сцену (например, коридор)
    // next: "corridor_intro"
  },

  // ============================================
  // КОНЦОВКА 2: ПРОШЕЛ, НО ПЯЛИЛСЯ (>= 4 ответа, пялился)
  // ============================================
  quiz_pass_stared: {
    id: "quiz_pass_stared",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "kagami",
        text: "Поздравляю, ты сдал..",
        showCharacter: {
          id: "kagami",
          emotion: "dominant",
          position: "center",
        },
      },
      { speaker: "", text: "Она это сказала с лёгкой насмешкой?" },
      {
        speaker: "",
        text: "Кагами подошла к доске и взяла оттуда толстую металлическую линейку, сантиметров на 50.",
      },
      {
        speaker: "kagami",
        text: "Но ты нарушил мои личные границы, когда посмел нагло пялиться на меня.",
      },
      {
        speaker: "",
        text: "Она встала прямо напротив меня с линейкой в руке.",
        showCharacter: { id: "kagami", emotion: "cold", position: "center" }, // Можно приблизить, если есть макрос
      },
      {
        speaker: "kagami",
        text: "Нет желания сейчас встать на колени и извиниться?",
      },
    ],
    // Переход на сцену с выбором (извиняться или быкануть)
    // next: "quiz_punishment_choice"
  },

  // ============================================
  // КОНЦОВКА 3: ПРОВАЛ (< 4 ответов) - ЛИЗАНИЕ НОГ
  // ============================================
  quiz_fail: {
    id: "quiz_fail",
    bg: "./bg/quiz_room.png",
    lines: [
      {
        speaker: "",
        text: "Я мирно ждал результатов, как вдруг почувствовал, как Кагами поставила свою ногу на мой стул.",
      },
      { speaker: "ren", text: "Кагами-сенс.." },
      {
        speaker: "ren",
        text: "Агх!",
        shake: "medium", // Тряска экрана от удара!
        audio: { type: "sfx", id: "hit_chair" }, // Звук падения стула
      },
      {
        speaker: "",
        text: "Она оттолкнула меня, и я грохнулся вместе со стулом на пол.",
      },
      {
        speaker: "",
        text: "Кагами встала надо мной, расставив ноги по бокам от меня.",
        showCharacter: {
          id: "kagami",
          emotion: "dominant",
          position: "center",
        },
      },
      { speaker: "ren", text: "Какого ху… Что вы делаете?!" },
      { speaker: "kagami", text: "Рен Амано, ты провалил тест." },
      {
        speaker: "kagami",
        text: "Ты проявил себя как ничтожество в первые же минуты своего прибытия.",
      },
      {
        speaker: "kagami",
        text: "Теперь тебя отправят обратно в твою школу, где тебя встретит полиция.",
      },
      {
        speaker: "kagami",
        text: "Твоя жизнь на этом закончилась.",
        effects: { sanity: -20 }, // Мощный удар по рассудку
      },
      { speaker: "", text: "…. Уже конец? Так просто?" },
      { speaker: "", text: "Так просто всё кончится?" },
      {
        speaker: "",
        text: "(Флешбек с сестренкой проносится перед глазами... Я не могу всё потерять.)",
        fx: { noise: 0.5, duration: 500 }, // Глитч-эффект для флешбека
      },
      {
        speaker: "kagami",
        text: "Не расстраивайся, Рен Амано, у меня есть вариант для таких как ты.",
        fx: { noise: 0, duration: 500 }, // Убираем глитч
      },
      { speaker: "ren", text: "… Я вас слушаю..." },
      {
        speaker: "",
        text: "Кагами сняла правый каблук и понесла ногу прямо над моим лицом.",
      },
      { speaker: "kagami", text: "Лижи." },
      { speaker: "ren", text: "Лизать?" },
      {
        speaker: "kagami",
        text: "Перестань тратить моё время, сейчас ты мусор, который должен заплатить за свою неудачу.",
      },
      { speaker: "kagami", text: "Лижи или вали в объятия полиции." },
    ],
    choices: [
      {
        text: "Провести языком по ступне (-10 доминации)",
        effects: { dominance: -10 },
        next: "quiz_fail_lick",
      },
      {
        text: "Кагами, идите нахер (+5 доминации)",
        req: { stat: "dominance", value: 10 }, // Кнопка заблокируется, если дом < 10
        effects: { dominance: 5 },
        next: "quiz_fail_reject",
      },
    ],
  },

  // Заглушки для продолжения провальной ветки
  quiz_fail_lick: {
    id: "quiz_fail_lick",
    bg: "./bg/quiz_room.png",
    lines: [
      { speaker: "", text: "Я подавил рвотный рефлекс и высунул язык..." },
    ],
  },

  quiz_fail_reject: {
    id: "quiz_fail_reject",
    bg: "./bg/quiz_room.png",
    lines: [{ speaker: "ren", text: "Да пошла ты." }],
  },

  // ============================================
  // === ПАСХАЛКА: ТАЙМЕР ИСТЁК ===
  // ============================================
  quiz_afk_fail: {
    id: "quiz_afk_fail",
    bg: "./bg/quiz_room.png",
    lines: [
      { speaker: "kagami", text: "Время вышло. Ты даже не попытался." },
      {
        speaker: "kagami",
        text: "Здесь тестово написана любая ерунда, как ты и просил.",
      },
      {
        speaker: "",
        text: "Кагами порвала мой листок пополам. Моя жизнь закончилась.",
      },
    ],
    // next: "game_over"
  },
};
